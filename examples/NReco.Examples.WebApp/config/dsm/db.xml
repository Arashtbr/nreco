<components
  xmlns:d="urn:schemas-nreco:nicnet:dalc:v1"
  xmlns:r="urn:schemas-nreco:nreco:core:v1" >
	
	<db-dalc name="db" xmlns="urn:schemas-nreco:nicnet:dalc:v1">
		<driver>
			<mssql>
				<connection><string name="mainDb"/></connection>			 
			</mssql>			
		</driver>
		<permissions>
			<query sourcename="accounts" operation="retrieve">
				1=1
			</query>
			<query sourcename="accounts" operation="update">
				username="{var:arg}"
			</query>
			
			<!-- database-layer retrieve permissions for pages -->
			<query sourcename="pages" operation="retrieve">
				is_public="true":boolean
				or
				author="{var:arg}"
				or
				id in page_visibility(
					page_visibility.account_id = accounts(accounts.username="{var:arg}")[accounts.id]
				)[page_visibility.page_id]
			</query>

		</permissions>
		<dataviews>
			<view name="accounts_view" origin="aa">
				<fields>
					<select>*</select>
					<count>count(*)</count>
					<mapping>
						<field name="account_id">a.id</field>				   
					</mapping>
				</fields>
				<sql>
					select {var:fields}
					from accounts a
					WHERE 1=1
					{ognl:@String@IsNullOrEmpty(#whereExpression) ? "" : " and "+#whereExpression}
					{ognl:@String@IsNullOrEmpty(#sortExpression) ? "" : " ORDER BY "+#sortExpression}
				</sql>	 
			</view>		  
		</dataviews>
		<triggers>
			<datarow event="updating" sourcename="accounts">
				<!-- set-row is custom definition, see config/xsl/extensions.xsl for details -->
				<r:set-row field-name="creation_date">
					<r:ognl>@DateTime@Now</r:ognl>
				</r:set-row>
			</datarow>
      <datarow event="inserting" sourcename="pages">
        <r:chain>
					<!-- set author -->
					<r:provide result="principal" target="serviceProviderContext">
						<r:context><r:const>currentPrincipal</r:const></r:context>
					</r:provide>
					<r:execute>
						<r:target>
							<r:set-row field-name="author">
								<r:ognl>#principal!=null ? #principal.Identity.Name : null</r:ognl>
							</r:set-row>
						</r:target>
					</r:execute>

					<!-- set creation date -->
					<r:execute>
						<r:target>
							<r:set-row field-name="creation_date">
								<r:ognl>@DateTime@Now</r:ognl>
							</r:set-row>
						</r:target>
					</r:execute>

					<!-- check title unique -->
          <r:provide result="title">
            <r:target>
							<d:dalc from="db">
								<d:query>pages(title="{databind:[row][title]}")[title]</d:query>
							</d:dalc>							
            </r:target>
          </r:provide>
          <r:execute if='#row["title"].ToString()==#title'>
            <r:target>
							<r:throw message="Page with such title already exists."/>
            </r:target>
          </r:execute>
        </r:chain>
      </datarow>
		</triggers>
	</db-dalc>	
	
	
</components>
